version: 2.1
jobs:
  build:
    docker:
      - image: circleci/ruby:2.4.2-jessie-node
        environment:
         BUNDLE_JOBS: 3
         BUNDLE_RETRY: 3
         BUNDLE_PATH: vendor/bundle
         PGHOST: 127.0.0.1
         PGUSER: circleci-demo-ruby
         RAILS_ENV: test
    steps:
      - checkout
      
      - run:
         name: Bundlerを指定
         command: cundle -vendor
         
      - restore_cache:
         keys:
          - rails-demo-bundle-v2-{{ checksum "Gemfile.lock" }}
          - rails-demo-bundle-v2-
          
      - run:
         name: バンドルインストール
         command: bundle check || bundle install||
         
      - save_cache:
         key: rails-demo-bundle-v2-{{ checksum "Gemfile.lock" }}
         paths:
          - vendor/bundle
          
      - run:
         name: DBを待機
         command: dockerize-wait tcp://localhost:5432 -timeout 1m
         
      - run:
         name: データベースをセットアップ
         command: bin/rails db:schema:load --trace
         
      - run: mkdir test-reports
      - run:
          name: Download Selenium
          command: curl -O http://selenium-release.storage.googleapis.com/3.5/selenium-server-standalone-3.5.3.jar
      - run:
          name: Start Selenium
          command: java -jar selenium-server-standalone-3.5.3.jar -log test-reports/selenium.log
          background: true
          
      - run:
          name: minitest
          command: rails test test/system